{% extends 'events/base.html' %}

{% block title %}Send Bulk Messages - Events Management{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
    <div class="mt-4 md:mt-0">
        &nbsp;
    </div>
</div>

<form method="post" id="bulk-message-form">
    {% csrf_token %}
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Message Content -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <div class="px-4 py-3 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-100">
                <h5 class="text-base font-semibold text-gray-900 flex items-center">
                    <span class="material-icons mr-2 text-blue-600 text-base">edit</span>Message Content
                </h5>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <div class="field-container">
                        <div class="input-field">
                            <textarea id="message" name="message" rows="4" 
                                      placeholder=" " required></textarea>
                            <label for="message" class="field-label">
                                Message <span class="text-red-500">*</span>
                            </label>
                            <div class="field-line"></div>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <span id="char-count">0</span>/500 characters
                        </div>
                    </div>
                    
                    <div class="field-container">
                        <div class="input-field">
                            <select id="method" name="method" required>
                                <option value=""></option>
                                {% for value, label in message_methods %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <label for="method" class="field-label">
                                Communication Method <span class="text-red-500">*</span>
                            </label>
                            <div class="field-line"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Templates -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <div class="px-4 py-3 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-100">
                <h5 class="text-base font-semibold text-gray-900 flex items-center">
                    <span class="material-icons mr-2 text-blue-600 text-base">lightbulb</span>Message Templates
                </h5>
            </div>
            <div class="p-6">
                <div class="space-y-3">
                    <button type="button" class="w-full text-left px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 border border-gray-200 hover:border-blue-300 rounded-xl transition-all duration-200 template-btn" 
                            data-template="Thank you for your pledge! We appreciate your commitment to our event.">
                        <div class="flex items-center">
                            <span class="material-icons text-green-600 mr-3">favorite</span>
                            <span class="text-sm font-medium text-gray-800">Thank You Message</span>
                        </div>
                    </button>
                    
                    <button type="button" class="w-full text-left px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 border border-gray-200 hover:border-blue-300 rounded-xl transition-all duration-200 template-btn" 
                            data-template="Friendly reminder: Your pledge payment is due. Please let us know when you plan to complete your payment.">
                        <div class="flex items-center">
                            <span class="material-icons text-orange-600 mr-3">notifications</span>
                            <span class="text-sm font-medium text-gray-800">Payment Reminder</span>
                        </div>
                    </button>
                    
                    <button type="button" class="w-full text-left px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 border border-gray-200 hover:border-blue-300 rounded-xl transition-all duration-200 template-btn" 
                            data-template="Great news! We're making excellent progress toward our goal. Thank you for being part of this journey!">
                        <div class="flex items-center">
                            <span class="material-icons text-blue-600 mr-3">trending_up</span>
                            <span class="text-sm font-medium text-gray-800">Progress Update</span>
                        </div>
                    </button>
                    
                    <button type="button" class="w-full text-left px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 border border-gray-200 hover:border-blue-300 rounded-xl transition-all duration-200 template-btn" 
                            data-template="Our event is coming up soon! We're excited to see you there. Please confirm your attendance.">
                        <div class="flex items-center">
                            <span class="material-icons text-purple-600 mr-3">event</span>
                            <span class="text-sm font-medium text-gray-800">Event Reminder</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipients Selection -->
    <div class="md-card">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h2 class="text-xl font-medium text-gray-800 flex items-center">
                <span class="material-icons text-primary-500 mr-3 text-2xl">group</span>
                Select Recipients
            </h2>
            <div class="flex items-center space-x-3">
                <button type="button" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-full shadow-md hover:shadow-lg transition-all duration-200" id="select-all">
                    <span class="material-icons mr-1 text-sm">select_all</span>
                    Select All
                </button>
                <button type="button" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 text-sm rounded-full shadow-md hover:shadow-lg transition-all duration-200" id="clear-all">
                    <span class="material-icons mr-1 text-sm">clear</span>
                    Clear All
                </button>
            </div>
        </div>
                <div>
                    {% if pledges %}
                        <div class="overflow-x-auto" style="min-height: 40vh; max-height: 60vh; overflow-y: auto;">
                            <table class="min-w-full">
                                <thead class="sticky-top">
                                    <tr class="border-b border-gray-100 bg-gradient-to-r from-gray-50 to-gray-100">
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-700" width="50">
                                            <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-700 flex items-center">
                                            <span class="material-icons text-sm mr-2">person</span>Name
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">
                                            <div class="flex items-center">
                                                <span class="material-icons text-sm mr-2">phone</span>Mobile
                                            </div>
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">
                                            <div class="flex items-center">
                                                <span class="material-icons text-sm mr-2">flag</span>Status
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    {% for pledge in pledges %}
                                    <tr class="border-b border-gray-50 hover:bg-blue-50 hover:shadow-sm transition-all duration-200 {% cycle 'bg-white' 'bg-gray-50' %}">
                                        <td class="px-6 py-1">
                                            <input type="checkbox" name="pledge_ids" value="{{ pledge.id }}" 
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 recipient-checkbox">
                                        </td>
                                        <td class="px-6 py-1">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-5 w-5 bg-primary-100 rounded-full flex items-center justify-center mr-2">
                                                    <span class="material-icons text-primary-600 text-xs">person</span>
                                                </div>
                                                <div>
                                                    <div class="text-xs font-medium text-gray-900">
                                                        {{ pledge.name }}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-1">
                                            <div class="text-xs text-gray-700">
                                                {{ pledge.mobile_number }}
                                            </div>
                                        </td>
                                        <td class="px-6 py-1">
                                            <div class="text-xs text-gray-700">
                                                {{ pledge.get_status_display }}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="material-icons text-primary-600 text-2xl">group</span>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No pledges available</h3>
                            <p class="text-gray-600 mb-6">Create pledges first to send messages</p>
                            <button onclick="openModal('{% url 'events:pledge_create' %}?modal=1')" 
                                    class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm rounded-full shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 44px;">
                                <span class="material-icons mr-2">add</span>
                                Create First Pledge
                            </button>
                        </div>
                    {% endif %}
                </div>
                {% if pledges %}
                <div class="border-t border-gray-100 p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">
                            <span id="selected-count">0</span> recipients selected
                        </span>
                        <button type="submit" class="inline-flex items-center px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white font-medium text-sm rounded-full shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2" id="send-button" disabled>
                            <span class="material-icons mr-2">send</span>
                            Send Bulk Messages
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
    </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<style>
/* Material Design 3 Field Styles - Transaction Modal Form Style */
:root {
    --primary: #6750a4;
    --on-primary: #ffffff;
    --surface: #fef7ff;
    --on-surface: #1d1b20;
    --on-surface-variant: #49454f;
    --outline: #79747e;
    --outline-variant: #cac4d0;
    --surface-variant: #e7e0ec;
    --surface-container-high: #ece6f0;
    --error: #ba1a1a;
    --shadow: rgba(0, 0, 0, 0.2);
}

.field-container {
    position: relative;
    margin-bottom: 1.5rem;
}

.input-field {
    position: relative;
    background: var(--surface-variant);
    border-radius: 4px 4px 0 0;
    transition: background-color 0.2s;
}

.input-field:focus-within {
    background: var(--surface-container-high);
}

.input-field input,
.input-field select,
.input-field textarea {
    width: 100%;
    height: 56px;
    padding: 24px 48px 8px 16px;
    border: none;
    background: transparent;
    font-size: 16px;
    line-height: 24px;
    color: var(--on-surface);
    outline: none;
    font-family: 'Roboto', sans-serif;
}

.input-field textarea {
    height: auto;
    min-height: 120px;
    resize: vertical;
    padding-top: 24px;
    padding-bottom: 8px;
}

.field-label {
    position: absolute;
    left: 16px;
    top: 16px;
    font-size: 16px;
    line-height: 24px;
    color: var(--on-surface-variant);
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: transparent;
    font-weight: 400;
}

.input-field input:focus + .field-label,
.input-field input:not(:placeholder-shown) + .field-label,
.input-field select:focus + .field-label,
.input-field select:not([value=""]) + .field-label,
.input-field textarea:focus + .field-label,
.input-field textarea:not(:placeholder-shown) + .field-label {
    top: 8px;
    font-size: 12px;
    line-height: 16px;
    color: var(--primary);
    font-weight: 500;
}

.field-line {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: var(--outline);
    transition: all 0.2s;
}

.field-line::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    right: 50%;
    height: 2px;
    background: var(--primary);
    transition: all 0.2s;
}

.input-field:focus-within .field-line::after {
    left: 0;
    right: 0;
}

.required {
    color: var(--error);
}

.field-error {
    color: var(--error);
    font-size: 12px;
    line-height: 16px;
    margin-top: 4px;
}

.field-hint {
    color: var(--on-surface-variant);
    font-size: 12px;
    line-height: 16px;
    margin-top: 4px;
}

/* Select dropdown styling */
.input-field select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2349454f' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 16px center;
    background-repeat: no-repeat;
    background-size: 16px;
}

.input-field select:focus {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236750a4' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageTextarea = document.getElementById('message');
    const charCount = document.getElementById('char-count');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const recipientCheckboxes = document.querySelectorAll('.recipient-checkbox');
    const selectedCount = document.getElementById('selected-count');
    const sendButton = document.getElementById('send-button');
    
    // Character counter
    function updateCharCount() {
        const length = messageTextarea.value.length;
        charCount.textContent = length;
        
        if (length > 400) {
            charCount.className = 'text-warning';
        } else if (length > 450) {
            charCount.className = 'text-danger';
        } else {
            charCount.className = 'text-muted';
        }
    }
    
    messageTextarea.addEventListener('input', updateCharCount);
    
    // Update selected count and button state
    function updateSelectedCount() {
        const checked = document.querySelectorAll('.recipient-checkbox:checked').length;
        selectedCount.textContent = checked;
        sendButton.disabled = checked === 0 || messageTextarea.value.trim() === '';
    }
    
    // Select all functionality
    selectAllCheckbox.addEventListener('change', function() {
        recipientCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // Individual checkbox changes
    recipientCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            
            // Update select all checkbox state
            const checkedCount = document.querySelectorAll('.recipient-checkbox:checked').length;
            const totalCount = recipientCheckboxes.length;
            
            selectAllCheckbox.checked = checkedCount === totalCount;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
        });
    });
    
    // Select all button
    document.getElementById('select-all').addEventListener('click', function() {
        recipientCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        selectAllCheckbox.checked = true;
        updateSelectedCount();
    });
    
    // Clear all button
    document.getElementById('clear-all').addEventListener('click', function() {
        recipientCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        updateSelectedCount();
    });
    
    // Template buttons
    document.querySelectorAll('.template-btn').forEach(button => {
        button.addEventListener('click', function() {
            const template = this.getAttribute('data-template');
            messageTextarea.value = template;
            updateCharCount();
            updateSelectedCount();
        });
    });
    
    
    // Update count on message change
    messageTextarea.addEventListener('input', updateSelectedCount);
    
    // Initial update
    updateCharCount();
    updateSelectedCount();
});
</script>
{% endblock %}